<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Grow From Earth - A LudumDare Game by James Mowery</title>
        <script src="lib/phaser.min.js"></script>
    </head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
    preload: preload,
    create: create,
    update: update,
    render: render
});

function preload () {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('platform', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.image('sun', 'assets/sun.png');
    game.load.image('plant', 'assets/plantend.png', 32, 48);
    game.load.image('plantBase', 'assets/plantbase.png');
}

var plant;
var ground;

var skyBG;
var menus;
var timeCheck;

var platforms;
var platformLocationX;
var platformsExist = false;
var scorePlatforms;
var player;
var cursors;

var collectables;
var gameSpeedModifier = 1;
var score = 0;
var boost = 0;
var scoreText;

var rope;

function create () {

    // Create the game world
    game.world.setBounds(0, -1200, 800, 1800);

    // Use Arcade Physics
    game.physics.startSystem(Phaser.Physics.ARCADE);

    // LEVEL CREATION ///////////////////////

    // Level Background
    skyBG = game.add.image(0, 0, 'sky');
    skyBG.fixedToCamera = true;

    platforms = game.add.group();
    platforms.enableBody = true; // Physics enabled for platforms group

    scorePlatforms = game.add.group();
    scorePlatforms.enableBody = true;

    collectables = game.add.group();
    collectables.enableBody = true;

    // Create the ground

    ground = game.add.image(0, 570, 'platform');
    ground.scale.setTo(2, 2);     // Scale ground to fit the game

    // PLAYER CREATION ///////////////////////

    makeRope();

    // Player settings
    // player = game.add.sprite(game.world.width / 2, 500, 'dude');
    plant = game.add.sprite(game.world.width / 2, 530, 'plant');
    game.physics.arcade.enable(plant); // Enable physics for plant
    plant.anchor.set(0.5);
    plant.body.collideWorldBounds = true;

    // SCORE KEEPER ///////////////////////
    scoreText = game.add.text(16, 16, 'Score: 0',
              { fontSize: '32px', fill: '#000' });

    // CONTROLS ///////////////////////
    cursors = game.input.keyboard.createCursorKeys();

    // MENU ///////////////////////
    menus = createMenu();
    timeCheck = game.time.now;

}

var gameState = 0;

function update () {

    switch(gameState) {
        case 0:
            // Show the menu
            showMenu(true);
            ground.visible = true;

            // Wait 3 seconds, then start game
            if (game.time.now - timeCheck > 3000) {
                showMenu(false);
                gameState = 1;
                platforms.y = -100;
                scorePlatforms.y = -100;
                collectables.y = -100;
                gameSpeedModifier = 1;
                ground.visible = false;
            }

            break;
        case 1:
            // Create the platforms
            if (platformsExist == false) {
                createPlatforms();
                createCollectables();
            }

            // Start platform and score box movement
            platforms.y         += (5 * gameSpeedModifier);
            scorePlatforms.y    += (5 * gameSpeedModifier);
            collectables.y      += (5 * gameSpeedModifier);

            break;
        case 2:
            // Lose
            // Reset Scores & Stats
            score = 0;
            boost = 0;

            // Reset score text
            scoreText.text = 'Score: ' + score;

            // Reset platforms and game state to menu
            platformsExist = false;
            gameState = 0;

            break;
        default:
            gameState = 1;
    }

    // COLLISION DETECTION ///////////////////////

    game.physics.arcade.collide(plant, scorePlatforms);
    game.physics.arcade.overlap(plant, scorePlatforms, addScore, null, this);
    game.physics.arcade.overlap(plant, platforms, gameOver, null, this);
    game.physics.arcade.overlap(plant, collectables, addBoost, null, this);

    // PLAYER CONTROLS ///////////////////////

    // Reset the player velocity (movement)
    plant.body.velocity.x = 0;
    plant.body.rotation = 0;

    // Move left keyboard
    if (cursors.left.isDown) {
        plant.body.velocity.x = -650;
        plant.body.rotation = -35;
    }

    // Move right keyboard
    else if (cursors.right.isDown) {
        plant.body.velocity.x = 650;
        plant.body.rotation = 35;
    }

    // Move left mouse
    else if (game.input.mousePointer.isDown &&
             game.input.mousePointer.x < 400) {
        plant.body.velocity.x = -650;
        plant.body.rotation = -35;
    }

    // Move right mouse
    else if (game.input.mousePointer.isDown &&
             game.input.mousePointer.x > 400) {
        plant.body.velocity.x = 650;
        plant.body.rotation = 35;
    }

    // Move left touch
    else if (game.input.pointer1.isDown && game.input.pointer1.x < 300) {
        plant.body.velocity.x = -650;
        plant.body.rotation = -35;
    }

    // Move right touch
    else if (game.input.pointer1.isDown && game.input.pointer1.x > 500) {
        console.log("HOLDING");
        plant.body.velocity.x = 650;
        plant.body.rotation = 35;
    }

    // Stop
    else {
        plant.body.velocity.x = 0;
        plant.body.rotation = 0;
    }

    rope.x = plant.x - 3;
}

function render() {
    // game.debug.pointer(game.input.pointer1);
}

function addBoost(plant, theBoost) {
    theBoost.kill();
    console.log("Adding Boost");

    if (gameSpeedModifier > 1) {
         gameSpeedModifier -= 0.05;
    }

    // boost = boost + 1;

}

function createCollectables() {
    var i = 0;

    for (i = 0; i < 100; i++) {
        //Math.floor(Math.random()*(max-min+1)+min);
        var rNum = Math.floor(Math.random()*(650-150+1)+150);
        var collectable = collectables.create(rNum,
            (i * - 375) - 970, 'sun');
        collectable.scale.setTo(0.75);
        collectable.body.immovable = true;
        collectable.visible = true;
    }

    console.log("Collectable Created");
}

function createPlatforms() {
    var i = 0;

    // Create random platforms upward
    for (i = 0; i < 100; i++) {
        //Math.floor(Math.random()*(max-min+1)+min);
        var rNum = Math.floor(Math.random()*(800-150+1)+150);
        rNum = rNum - 1000;
        platformLocationX = rNum;
        var platform = platforms.create(rNum,
            (-375 * i) - 800, 'platform');
        platform.scale.setTo(2, 2);
        platform.body.immovable = true;
        platform.visible = true;

        platform = platforms.create(rNum + 1000, (-375 * i) - 800, 'platform');
        platform.scale.setTo(2, 2);
        platform.body.immovable = true;
        platform.visible = true;

        platform = scorePlatforms.create(rNum + 500, (-375 * i) - 865, 'platform');
        platform.scale.setTo(2, 2);
        platform.alpha = 0;
    }

    platformsExist = true;
}

function gameOver(plant, platform) {
    // TODO: Show Game Over Screen With Score Overview

    timeCheck = game.time.now;
    platforms.removeAll();
    scorePlatforms.removeAll();
    collectables.removeAll();
    gameState = 2;
}

function addScore(plant, platform) {
    platform.kill();

    score += 1;
    gameSpeedModifier += 0.05;
    scoreText.text = 'Score: ' + score;
}

function createMenu() {

    var menuTitle = game.add.text(game.width / 2, game.height / 2 - 100,
            'Grow From Earth', { fontSize: '72px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });

    menuTitle.anchor.x = 0.5;
    menuTitle.anchor.y = 0.5;

    var menuAbout = game.add.text(game.width / 2, game.height / 2 + 50,
            'A LudumDare Game\nby James Mowery', { fontSize: '32px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });
    menuAbout.anchor.x = 0.5;
    menuAbout.anchor.y = 0.5;

    var menuLink = game.add.text(game.width / 2, game.height / 2 + 175,
            'http://mowery.co/', { fontSize: '32px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });
    menuLink.anchor.x = 0.5;
    menuLink.anchor.y = 0.5;

    var menus = {
        'title' : menuTitle,
        'about' : menuAbout,
        'link'  : menuLink
    }

    return menus;
}

function showMenu(visible) {
    menus.title.visible = visible;
    menus.about.visible = visible;
    menus.link.visible = visible;
}

function makeRope() {
    var count = 0;
    var length = 918 / 20;
    var points = [];

    for (var i = 0; i < 20; i++)
    {
        points.push(new Phaser.Point(i * length, 0));
    }

    rope = game.add.rope(400, 600, 'plantBase', null, points);
    rope.scale.set(0.06);

    rope.updateAnimation = function() {
        count += 0.1;

        for (var i = 0; i < this.points.length; i++)
        {
            this.points[i].y = Math.sin(i * 0.5 + count) * 10;
        }
    };
    rope.rotation = 29.9;
}

</script>

</body>
</html>
