<!doctype html>
<html>
    <head>
        <meta charset="UTF-8" />
        <title>Grow From Earth - A LudumDare Game by James Mowery</title>
        <script src="lib/phaser.min.js"></script>
    </head>
<body>

<script type="text/javascript">

var game = new Phaser.Game(800, 600, Phaser.AUTO, '', {
    preload: preload,
    create: create,
    update: update,
    render: render
});

function preload () {
    game.load.image('sky', 'assets/sky.png');
    game.load.image('platform', 'assets/platform.png');
    game.load.image('star', 'assets/star.png');
    game.load.spritesheet('dude', 'assets/dude.png', 32, 48);
}

var platform;
var platforms;
var platformsExist = false;
var scorePlatforms;
var player;
var cursors;

var distance = 0;

var skyBG;

var menus;
var timeCheck;

var stars;

var score = 0;
var scoreText;

function create () {
    // Create the game world
    // game.world.setBounds(0, -10000, 800, 10000);
    game.world.setBounds(0, -1200, 800, 1800);
    // Use Arcade Physics
    game.physics.startSystem(Phaser.Physics.ARCADE);

    // LEVEL CREATION ///////////////////////

    // Level Background
    skyBG = game.add.image(0, 0, 'sky');
    skyBG.fixedToCamera = true;

    // Platforms - Group contains the ground and 2 ledges
    platforms = game.add.group();
    platforms.enableBody = true; // Physics enabled for platforms group

    scorePlatforms = game.add.group();
    scorePlatforms.enableBody = true;

    // Create the ground
    /*
    var ground = platforms.create(0, 1100, 'platform');
    ground.scale.setTo(2, 2);     // Scale ground to fit the game
    ground.body.immovable = true; // Prevent ground from moving on jump
    */

    // Create the ledges & make it immovable
    /*
    var platform = platforms.create(300, -200, 'platform');
    platform.body.immovable = true;
    platform = platforms.create(-150, -550, 'platform');
    platform.body.immovable = true;
    */

    // PLAYER CREATION ///////////////////////

    // Player settings
    player = game.add.sprite(game.world.width / 2, 500,
                             'dude');

    // game.camera.bounds = null;

    game.physics.arcade.enable(player); // Enable physics for player

    // Player physics settings
    // player.body.bounce.y = 0.2; // Adds bouncy properties
    // player.body.gravity.y = 300; // Adds gravity properties
    player.body.collideWorldBounds = true; // Collision with world edge

    // Player animation, walking left and right
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 8], 10, true);

    // SCORE KEEPER ///////////////////////
    scoreText = game.add.text(16, 16, 'Score: 0',
              { fontSize: '32px', fill: '#000' });

    // CONTROLS ///////////////////////
    cursors = game.input.keyboard.createCursorKeys();

    // MENU ///////////////////////
    menus = createMenu();
    timeCheck = game.time.now;
}

/*
Game States
0 = Menu
1 = Game
2 = Win
*/

var gameState = 0;

function update () {

    switch(gameState) {
        case 0:
            // Set the menu to be visible
            // menuVisible = true;
            console.log("MENU CALLED");
            showMenu(true);

            // Wait until input or 3 seconds
            if (game.time.now - timeCheck > 3000) {
                showMenu(false);
                gameState = 1;
                platforms.y = -100;
                scorePlatforms.y = -100;
            }
            break;
        case 1:
            // Create the platforms
            if (platformsExist == false) {
                console.log("Creating Platforms");
                createPlatforms();
            }

            // Start the platforms moving downwards
            platforms.y += 5;
            scorePlatforms.y += 5;
            distance += 1;
            break;
        case 2:
            // Lose
            console.log("GAME STATE OVER TRIGGERED");
            // Reset Score
            distance = 0;
            score = 0;
            scoreText.text = 'Score: ' + score;

            gameState = 0;
            platformsExist = false;

            break;
        default:
            gameState = 1;
    }

    // COLLISION DETECTION ///////////////////////

    // Collide the player and the stars with the platforms
    game.physics.arcade.collide(stars, platforms);

    // game.physics.arcade.overlap(player, stars, collectStar, null, this);
    game.physics.arcade.collide(player, scorePlatforms);
    game.physics.arcade.overlap(player, scorePlatforms, addScore, null, this);
    game.physics.arcade.overlap(player, platforms, gameOver, null, this);

    // PLAYER CONTROLS ///////////////////////

    // Reset the player velocity (movement)
    player.body.velocity.x = 0;

    // Move left keyboard
    if (cursors.left.isDown) {
        player.body.velocity.x = -600;
        player.animations.play('left');
    }

    // Move right keyboard
    else if (cursors.right.isDown) {
        player.body.velocity.x = 600;
        player.animations.play('right');
    }

    // Move left mouse
    else if (game.input.mousePointer.isDown &&
             game.input.mousePointer.x < 400) {
        console.log("HOLDING MOUSE");
        player.body.velocity.x = -600;
        player.animations.play('left');
    }

    // Move right mouse
    else if (game.input.mousePointer.isDown &&
             game.input.mousePointer.x > 400) {
        console.log("HOLDING MOUSE");
        player.body.velocity.x = 600;
        player.animations.play('right');
    }

    // Move left touch
    else if (game.input.pointer1.isDown && game.input.pointer1.x < 300) {
        console.log("HOLDING");
        player.body.velocity.x = -600;
        player.animations.play('left');
    }

    // Move right touch
    else if (game.input.pointer1.isDown && game.input.pointer1.x > 500) {
        console.log("HOLDING");
        player.body.velocity.x = 600;
        player.animations.play('right');
    }

    // Stop
    else {
        player.animations.stop();
        player.frame = 4;
    }

}

function render() {
    // game.debug.pointer(game.input.pointer1);
}

function createPlatforms() {
    var i = 0;

    /*
    platform = platforms.create(400, -500, 'platform');
    platform.scale.setTo(2, 2);
    platform.body.immovable = true;
    platform.visible = true;
    */

    // Create random platforms upward
    for (i = 0; i < 100; i++) {
        //Math.floor(Math.random()*(max-min+1)+min);
        var rNum = Math.floor(Math.random()*(800-150+1)+150);
        rNum = rNum - 1000;
        var platform = platforms.create(rNum,
            (-375 * i) - 800, 'platform');
        platform.scale.setTo(2, 2);
        platform.body.immovable = true;
        platform.visible = true;

        platform = platforms.create(rNum + 1000, (-375 * i) - 800, 'platform');
        platform.scale.setTo(2, 2);
        platform.body.immovable = true;
        platform.visible = true;

        platform = scorePlatforms.create(rNum + 500, (-375 * i) - 865, 'platform');
        platform.scale.setTo(2, 2);
        platform.alpha = 0;
    }

    platformsExist = true;
}

function gameOver(player, platform) {
    console.log("Game Over Triggered");
    // player.position.x = game.world.width / 2;

    // TODO: Show Game Over Screen With Score Overview

    // Return to menu/start over

    timeCheck = game.time.now;
    platforms.removeAll();
    scorePlatforms.removeAll();
    gameState = 2;
}

function addScore(player, platform) {
    console.log("SCORE FIRED");
    platform.kill();

    score += 1;
    scoreText.text = 'Score: ' + score;
}

/*
function collectStar(player, star) {
    // Removes the star from the screen
    star.kill();

    // Update the score
    score += 1;
    scoreText.text = 'Score: ' + score;
}
*/

function createMenu() {

    var menuTitle = game.add.text(game.width / 2, game.height / 2 - 100,
            'Growing From Earth', { fontSize: '72px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });

    menuTitle.anchor.x = 0.5;
    menuTitle.anchor.y = 0.5;

    var menuAbout = game.add.text(game.width / 2, game.height / 2 + 50,
            'A LudumDare Game\nby James Mowery', { fontSize: '32px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });
    menuAbout.anchor.x = 0.5;
    menuAbout.anchor.y = 0.5;

    var menuLink = game.add.text(game.width / 2, game.height / 2 + 175,
            'http://mowery.co/', { fontSize: '32px',
                                    fill: '#FFF',
                                    stroke: 'black',
                                    strokeThickness: 3 });
    menuLink.anchor.x = 0.5;
    menuLink.anchor.y = 0.5;

    var menus = {
        'title' : menuTitle,
        'about' : menuAbout,
        'link'  : menuLink
    }

    return menus;
}

function showMenu(visible) {
    menus.title.visible = visible;
    menus.about.visible = visible;
    menus.link.visible = visible;
}

</script>

</body>
</html>
